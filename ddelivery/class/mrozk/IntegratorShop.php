<?php
/**
 * Created by PhpStorm.
 * User: mrozk
 * Date: 4/28/14
 * Time: 11:47 AM
 */

use DDelivery\Order\DDeliveryProduct;
use DDelivery\Adapter\PluginFilters;
use DDelivery\Order\DDStatusProvider;
//ini_set("display_errors", "1");
//error_reporting(E_ALL);

class IntegratorShop extends PluginFilters {

    public $cmsSettings;

    public $fields;

    protected  $cmsOrderStatus = array( DDStatusProvider::ORDER_IN_PROGRESS => 0,
                                        DDStatusProvider::ORDER_CONFIRMED => 2,
                                        DDStatusProvider::ORDER_IN_STOCK => 14,
                                        DDStatusProvider::ORDER_IN_WAY => 15,
                                        DDStatusProvider::ORDER_DELIVERED => 16,
                                        DDStatusProvider::ORDER_RECEIVED => 17,
                                        DDStatusProvider::ORDER_RETURN => 20,
                                        DDStatusProvider::ORDER_CUSTOMER_RETURNED => 21,
                                        DDStatusProvider::ORDER_PARTIAL_REFUND => 22,
                                        DDStatusProvider::ORDER_RETURNED_MI => 2,
                                        DDStatusProvider::ORDER_WAITING => 25,
                                        DDStatusProvider::ORDER_CANCEL => 26 );

    public function __construct( $fields = array() )
    {
        $this->fields = $fields;
        $query = 'SELECT * FROM ddelivery_module_system WHERE id = 1';
        $cur = mysql_query($query);
        $this->cmsSettings = mysql_fetch_assoc($cur);

    }


    /**
     * ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
     * @return array
     */
    public function getDbConfig()
    {
        $user_db = $GLOBALS['SysValue']['connect']['user_db'];
        $pass_db = $GLOBALS['SysValue']['connect']['pass_db'];
        $dbase = $GLOBALS['SysValue']['connect']['dbase'];
        $host = $GLOBALS['SysValue']['connect']['host'];

        return array(
            'pdo' => new \PDO('mysql:host=' . $host . ';dbname=' . $dbase , $user_db, $pass_db, array(\PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES cp1251")),
            'prefix' => 'ddelivery_module_',
        );

        return array(
            'type' => self::DB_SQLITE,
            'dbPath' => $this->getPathByDB(),
            'prefix' => '',
        );

        return array(
            'type' => self::DB_MYSQL,
            'dsn' => 'mysql:host=localhost;dbname=ddelivery',
            'user' => 'root',
            'pass' => '0',
            'prefix' => '',
        );
    }

    public function isStatusToSendOrder( $status )
    {
        if( $this->cmsSettings['status'] == $status )
        {
            return true;
        }
        return false;
    }
    /**
     * Ğ’ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ true ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹(stage) ÑĞµÑ€Ğ²ĞµÑ€
     * @return bool
     */
    public function isTestMode()
    {
        if ( $this->cmsSettings['rezhim']  == '0')
        {
            return true;
        }
        elseif($this->cmsSettings['rezhim']  == '1')
        {
            return false;
        }
        // TODO: Change the autogenerated stub
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸ĞµÑÑ Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ·Ğ°ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
     * @return DDeliveryProduct[]
     */
    protected function _getProductsFromCart()
    {

        $products = array();
        // ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°
        $PHPShopCart = new PHPShopCart();
        $productsCart = $PHPShopCart->getArray();

        if( count( $productsCart ) )
        {
            foreach($productsCart as $item)
            {

                $PHPShopProduct = new PHPShopProduct($item['id']);


                $cartWidth = $PHPShopProduct->getParam("option1");
                $cartLenght = $PHPShopProduct->getParam("option2");
                $cartHeight = $PHPShopProduct->getParam("option3");


                $cartWeight = $item['weight'] / 1000;


                $width = (empty($cartWidth)?$this->cmsSettings['def_width']:$cartWidth);
                $lenght = (empty($cartLenght)?$this->cmsSettings['def_lenght']:$cartLenght);
                $height = (empty($cartHeight)?$this->cmsSettings['def_height']:$cartHeight);
                $weight = (empty($cartWeight)?$this->cmsSettings['def_weight']:$cartWeight);

                $products[] = new \DDelivery\Order\DDeliveryProduct( $item['id'],
                    $width, $height, $lenght, $weight,
                    $item['price'], $item['num'], iconv('windows-1251', 'UTF-8',$item['name']), $item['uid']);


            }
        }

        return $products;
    }

    /**
     * ĞœĞµĞ½ÑĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ° cms
     *
     * @param $cmsOrderID - id Ğ·Ğ°ĞºĞ°Ğ·Ğ°
     * @param $status - ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
     *
     * @return bool
     */
    public function setCmsOrderStatus($cmsOrderID, $status)
    {
        $orders = $GLOBALS['SysValue']['base']['orders'];
        $query = 'UPDATE ' . $orders . ' SET statusi = ' . $status . ' WHERE id = ' . $cmsOrderID;
        $cur = mysql_query($query);
        $this->cmsSettings = mysql_fetch_assoc($cur);
    }

    public function getOrderIDsByStatus()
    {
        $orders = $GLOBALS['SysValue']['base']['orders'];

        $query = 'SELECT uid FROM ' . $orders . ' WHERE statusi =' . $this->cmsSettings['status'];
        $cur = mysql_query($query);
        $result = array();
        while ($k = mysql_fetch_array($cur))
        {
            $result[] = $k[0];
        }

        return $result;
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ API ĞºĞ»ÑÑ‡, Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ´Ğ»Ñ Ğ’Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ
     * @return string
     */
    public function getApiKey()
    {
        return $this->cmsSettings['api'];
    }

    /**
     * Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ url Ğ´Ğ¾ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¾Ğ¹
     * @return string
     */
    public function getStaticPath()
    {
        return '../html/';
    }

    /**
     * URL Ğ´Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ³Ğ´Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ DDelivery::render
     * @return string
     */
    public function getPhpScriptURL()
    {
        // Ğ¢Ğ¾ĞµÑÑ‚ÑŒ Ğ´Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°
        unset( $this->fields['iframe'] );
        return 'ajax.php?' . http_build_query($this->fields);
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿ÑƒÑ‚ÑŒ Ğ´Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ² Ğ¼ĞµÑÑ‚Ğ¾ Ğ½Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğµ Ğ¿Ğ¾ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞµ
     * @return string
     */
    public function getPathByDB()
    {
        return __DIR__.'/../db/db.sqlite';
    }

    /**
     * ĞœĞµÑ‚Ğ¾Ğ´ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸
     * @param int $orderId
     * @return bool
     */
    public function onFinishChange( $order ){}

    /**
     * ĞšĞ°ĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾Ñ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑÑ‚Ñ€Ğ°Ñ…ÑƒĞµÑ‚ÑÑ
     * @return float
     */
    public function getDeclaredPercent()
    {
        return $this->cmsSettings['declared'];
    }


    /**
     * Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ  Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² ĞºÑƒÑ€ÑŒĞµÑ€ĞºĞµ
     *
     * @return int[]
     */
    public function filterCompanyPointCourier(){
        $cur_companies = unserialize( $this->cmsSettings['cur_companies'] );
        if( empty( $cur_companies ) )
        {
            $res = array();
        }
        else
        {
            $res = array_values($cur_companies) ;
        }
        return $res;
        // TODO: Implement filterCompanyPointCourier() method.
    }

    /**
     * Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ  Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² ÑĞ°Ğ¼Ğ¾Ğ²Ñ‹Ğ²Ğ¾Ğ·Ğµ
     *
     * @return int[]
     */
    public function filterCompanyPointSelf(){
        $cur_companies = unserialize( $this->cmsSettings['pvz_companies'] );
        if( empty( $cur_companies ) )
        {
            $res = array();
        }
        else
        {
            $res = array_values($cur_companies) ;
        }
        return $res;
        // TODO: Implement filterCompanyPointSelf() method.
    }



    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ¹ PluginFilters::PAYMENT_, Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ. ĞšÑƒÑ€ÑŒĞµÑ€
     * @return int
     */
    public function filterPointByPaymentTypeCourier()
    {
        return $this->cmsSettings['payment'];
        /*
        return self::PAYMENT_POST_PAYMENT;
        // Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· 3 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²(ÑĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğº ĞºĞ¾Ğ½ÑÑ‚Ğ°Ñ‚Ğ°Ğ¼)
        return self::PAYMENT_POST_PAYMENT;
        return self::PAYMENT_PREPAYMENT;
        return self::PAYMENT_NOT_CARE;
        */
        // TODO: Implement filterPointByPaymentTypeCourier() method.
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ¹ PluginFilters::PAYMENT_, Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ. Ğ¡Ğ°Ğ¼Ğ¾Ğ²Ñ‹Ğ²Ğ¾Ğ·
     * @return int
     */
    public function filterPointByPaymentTypeSelf()
    {
        return $this->cmsSettings['payment'];
        //return self::PAYMENT_POST_PAYMENT;
        // Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· 3 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²(ÑĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğº ĞºĞ¾Ğ½ÑÑ‚Ğ°Ñ‚Ğ°Ğ¼)
        /*
        return self::PAYMENT_POST_PAYMENT;
        return self::PAYMENT_PREPAYMENT;
        return self::PAYMENT_NOT_CARE;
        // TODO: Implement filterPointByPaymentTypeSelf() method.
        */
    }
    public function getClientLastName() {
        return '';
    }
    /**
     * Ğ•ÑĞ»Ğ¸ true, Ñ‚Ğ¾ Ğ½Ğµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ†ĞµĞ½Ñƒ Ğ·Ğ°Ğ±Ğ¾Ñ€Ğ°
     * @return bool
     */
    public function isPayPickup()
    {
        $zabor = (int)$this->cmsSettings['zabor'];
        if( $zabor ) return true;
        else         return false;
        // TODO: Implement isPayPickup() method.
    }

    /**
     * ĞœĞµÑ‚Ğ¾Ğ´ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ñ‹ Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸
     *
     * @return array
     */
    public function getIntervalsByPoint()
    {
        $result = array();
        if( !empty( $this->cmsSettings['from1'] ) &&  !empty( $this->cmsSettings['to1'] ) && !empty( $this->cmsSettings['method1'] )  )
        {
            $result[] = array('min' => $this->cmsSettings['from1'], 'max'=>$this->cmsSettings['to1'],
                              'type'=>$this->cmsSettings['method1'], 'amount'=>$this->cmsSettings['methodval1']);
        }
        if( !empty( $this->cmsSettings['from2'] ) &&  !empty( $this->cmsSettings['to2'] ) && !empty( $this->cmsSettings['method2'] ) )
        {
            $result[] = array('min' => $this->cmsSettings['from2'], 'max'=>$this->cmsSettings['to2'],
                              'type'=>$this->cmsSettings['method2'], 'amount'=>$this->cmsSettings['methodval2']);
        }
        if( !empty( $this->cmsSettings['from3'] ) &&  !empty( $this->cmsSettings['to3'] ) && !empty( $this->cmsSettings['method3']  ) )
        {
            $result[] = array('min' => $this->cmsSettings['from3'], 'max'=>$this->cmsSettings['to3'],
                              'type'=>$this->cmsSettings['method3'], 'amount'=>$this->cmsSettings['methodval3']);
        }
        return $result;
        /*
        return array(
            array('min' => 0, 'max'=>100, 'type'=>self::INTERVAL_RULES_MARKET_AMOUNT, 'amount'=>30),
            array('min' => 100, 'max'=>200, 'type'=>self::INTERVAL_RULES_CLIENT_ALL, 'amount'=>60),
            array('min' => 300, 'max'=>400, 'type'=>self::INTERVAL_RULES_MARKET_PERCENT, 'amount'=>3),
            array('min' => 1000, 'max'=>null, 'type'=>self::INTERVAL_RULES_MARKET_ALL),
        );
        */
    }

    /**
     * Ğ¢Ğ¸Ğ¿ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ñ
     * @return int
     */
    public function aroundPriceType(){
        switch ($this->cmsSettings['okrugl']){
            case '0': return self::AROUND_FLOOR;
            case '1': return self::AROUND_CEIL;
            case '2': return self::AROUND_ROUND;
            default : return self::AROUND_ROUND;
        }
        //return self::AROUND_ROUND; // self::AROUND_FLOOR, self::AROUND_CEIL
    }

    /**
     * Ğ¨Ğ°Ğ³ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ñ
     * @return float
     */
    public function aroundPriceStep()
    {
        $this->cmsSettings['shag'];
        return $this->cmsSettings['shag']; // Ğ”Ğ¾ 50 ĞºĞ¾Ğ¿ĞµĞµĞº
        // TODO: Implement aroundPriceStep() method.
    }

    /**
     * Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ»ÑƒĞ¶Ğ± Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸
     * @return string
     */
    public function getCustomPointsString()
    {
        return $this->cmsSettings['custom_point'];
    }

    /**
     * Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ·Ğ½Ğ°ĞµÑ‚Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»Ñ, ÑĞ´ĞµĞ»Ğ°Ğ¹Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¾ÑÑŒ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğµ
     * @return string|null
     */
    public function getClientFirstName() {
        if( isset( $this->fields['name_person'])  ){
            return trim($this->fields['name_person']);
        }
        return '';
    }



    /**
     * Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ·Ğ½Ğ°ĞµÑ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»Ñ, ÑĞ´ĞµĞ»Ğ°Ğ¹Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¾ÑÑŒ
     * Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğµ. 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 9211234567
     *
     *@return string|null
     */
    public function getClientPhone() {
        if( isset( $this->fields['tel_name'])  ){
            $tel_name = $this->formatPhone( $this->fields['tel_name'] );
            $tel_name  = substr( $tel_name, -10);
            return '+7' . $tel_name;
        }
        return '';
    }
    /**
     * Âûğåçàåì èç íîìåğà òåëåôîíà íåíóæíûå ñèìâîëû
     *
     * @param string $phone
     *
     * @return string
     */
    public function formatPhone( $phone )
    {
        return preg_replace( array('/-/', '/\(/', '/\)/', '/\+7/', '/\s\s+/'), '', $phone );
    }
    /**
     * Ğ’ĞµÑ€Ğ½Ğ¸ Ğ¼Ğ°ÑÑĞ¸Ğ² ĞĞ´Ñ€ĞµÑ, Ğ”Ğ¾Ğ¼, ĞšĞ¾Ñ€Ğ¿ÑƒÑ, ĞšĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· get*RequiredFields
     * @return string[]
     */
    public function getClientAddress() {
        if( isset( $this->fields['adr_name'])  ){
            return array($this->fields['adr_name']);
        }

        return array(/*'ĞĞ´Ñ€ĞµÑx','Ğ”Ğ¾Ğ¼x', 'ĞšĞ¾Ñ€Ğ¿ÑƒÑx','ĞšĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°x'*/);
    }

    public function getClientEmail(){
        return $this->fields['mail'];
    }
    /**
     * Ğ’ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ id Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ° Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ DDelivery
     * @return int
     */
    public function getClientCityId()
    {
        // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ, Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°.
        return parent::getClientCityId();
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸
     * @return array
     */
    public function getSupportedType(){
        if( $this->cmsSettings['type'] == '0' )
        {
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER,
                \DDelivery\Sdk\DDeliverySDK::TYPE_SELF
            );
        }
        elseif($this->cmsSettings['type'] == '1')
        {
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_SELF
            );
        }
        elseif($this->cmsSettings['type'] == '2')
        {
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER,
            );
        }
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½ÑƒÑ Ğ¼Ğ°ÑĞºÑƒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ ĞºÑƒÑ€ÑŒĞµÑ€Ğ°
     * Ğ•ÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾, Ğ½Ğ¾ ĞµÑÑ‚ÑŒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ
     * Ğ•ÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼ ÑˆĞ°Ğ³
     * @return int
     */
    public function getCourierRequiredFields(){
        // Ğ’Ğ’ĞµÑÑ‚Ğ¸ Ğ²ÑĞµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾, ĞºÑ€Ğ¾Ğ¼Ğµ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ°
        return self::FIELD_EDIT_FIRST_NAME | self::FIELD_REQUIRED_FIRST_NAME
        | self::FIELD_EDIT_PHONE | self::FIELD_REQUIRED_PHONE
        | self::FIELD_EDIT_ADDRESS | self::FIELD_REQUIRED_ADDRESS
        | self::FIELD_EDIT_ADDRESS_HOUSE | self::FIELD_REQUIRED_ADDRESS_HOUSE
        | self::FIELD_EDIT_ADDRESS_HOUSING
        | self::FIELD_EDIT_ADDRESS_FLAT | self::FIELD_REQUIRED_ADDRESS_FLAT | self::FIELD_EDIT_EMAIL;
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½ÑƒÑ Ğ¼Ğ°ÑĞºÑƒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ² ÑĞ°Ğ¼Ğ¾Ğ²Ñ‹Ğ²Ğ¾Ğ·Ğ°
     * Ğ•ÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾, Ğ½Ğ¾ ĞµÑÑ‚ÑŒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ
     * Ğ•ÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼ ÑˆĞ°Ğ³
     * @return int
     */
    public function getSelfRequiredFields(){
        // ĞĞ¼Ñ, Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ, Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞºĞ°
        return self::FIELD_EDIT_FIRST_NAME | self::FIELD_REQUIRED_FIRST_NAME
        | self::FIELD_EDIT_PHONE | self::FIELD_REQUIRED_PHONE | self::FIELD_EDIT_EMAIL;
    }


    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ñ‹ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¡Ğ°Ğ¼Ğ¾Ğ²Ñ‹Ğ²Ğ¾Ğ·Ğ° ( Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ order )
     * @param $order DDeliveryOrder
     * @return array
     */
    public function getSelfPaymentVariants( $order ){

        $self_list = unserialize( $this->cmsSettings['self_list'] );
        if( !is_array($self_list)){
            $self_list = array();
        }
        return $self_list;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ñ‹ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ ĞºÑƒÑ€ÑŒĞµÑ€Ğ° ( Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ order )
     * @param $order DDeliveryOrder
     * @return array
     */
    public function getCourierPaymentVariants( $order ){

        $courier_list = unserialize( $this->cmsSettings['courier_list'] );
        if( !is_array($courier_list)){
            $courier_list = array();
        }
        return $courier_list;
    }
    public function onFinishResultReturn(  $order, $resultArray  ){
        if($order->type == \DDelivery\Sdk\DDeliverySDK::TYPE_SELF){
            $resultArray['payment'] = json_encode($this->getSelfPaymentVariants( $order ));
        }else{
            $resultArray['payment'] = json_encode($this->getCourierPaymentVariants( $order ));
        }
        return $resultArray;
    }
} 
